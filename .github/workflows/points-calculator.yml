name: Points Calculator

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Fires on every PR merge across this repo.
# Writes points to the CENTRAL leaderboard repo: gdg-charusat/sprintathon-leaderboard
# PAT_TOKEN must be added as a secret in every participating repo.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  pull_request_target:
    types: [closed]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  calculate-points:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # Check out the CENTRAL leaderboard repo (not this repo)
      # so we can read and update leaderboard.json there.
      - name: Checkout central leaderboard repo
        uses: actions/checkout@v4
        with:
          repository: gdg-charusat/sprintathon-leaderboard
          ref: main
          token: ${{ secrets.PAT_TOKEN }}
          path: leaderboard-repo

      - name: Calculate and Award Points
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const fs       = require('fs');
            const pr       = context.payload.pull_request;
            const body     = pr.body || '';
            const prNumber = pr.number;
            const author   = pr.user.login;
            const sourceRepo = context.repo.repo;   // which of the 6 repos this came from
            const footer   = '\n\n> GDG CHARUSAT Open Source Contri Sprintathon';

            const postComment = async (text) => {
              await github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: prNumber,
                body:         text
              });
            };

            // â”€â”€ 1. Extract team number â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const teamMatch = body.match(/team\s*(\d+)/i);
            if (!teamMatch) {
              await postComment(
                `## âš ï¸ Points Not Awarded\n\n` +
                `This PR was merged but no team number was found in the description.\n\n` +
                `Please contact the organizers to have your points manually added:\n` +
                `- WhatsApp: +91-8347036131\n` +
                `- Email: jadejakrishnapal04@gmail.com` +
                footer
              );
              return;
            }

            const teamNumber = teamMatch[1].padStart(2, '0');
            const teamLabel  = `Team ${teamNumber}`;

            // â”€â”€ 2. Determine points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const levelFromLabels = (labelNames) => {
              const lower = labelNames.map(n => n.toLowerCase());
              if (lower.includes('level-2') || lower.includes('intermediate'))
                return { points: 20, level: 'Level 2 â€” Intermediate' };
              if (lower.includes('level-1') || lower.includes('beginner') || lower.includes('good-first-issue'))
                return { points: 5,  level: 'Level 1 â€” Beginner' };
              return null;
            };

            const issueMatch     = body.match(/(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#(\d+)/i);
            const hasLinkedIssue = Boolean(issueMatch);

            let points      = 0;
            let level       = '';
            let pointSource = '';

            if (hasLinkedIssue) {
              const issueNumber = parseInt(issueMatch[3]);
              pointSource = `Linked Issue #${issueNumber}`;
              try {
                const issueData  = await github.rest.issues.get({
                  owner: context.repo.owner, repo: context.repo.repo,
                  issue_number: issueNumber
                });
                const result = levelFromLabels(issueData.data.labels.map(l => l.name));
                if (result) {
                  points = result.points; level = result.level;
                } else {
                  const prResult = levelFromLabels(pr.labels.map(l => l.name));
                  if (prResult) {
                    points = prResult.points; level = prResult.level + ' (from PR label)';
                  } else {
                    points = 5; level = 'Level 1 â€” Beginner (fallback)';
                  }
                }
              } catch (_) {
                points = 5; level = 'Level 1 â€” Beginner (fallback: issue not found)';
              }
            } else {
              pointSource    = 'General Improvement PR â€” level assigned by admin';
              const prResult = levelFromLabels(pr.labels.map(l => l.name));
              if (!prResult) {
                await postComment(
                  `## âš ï¸ Points Could Not Be Calculated\n\n` +
                  `This General Improvement PR was merged without a \`level-1\` or \`level-2\` label.\n\n` +
                  `**Admin action required:** manually add points for **${teamLabel}** in the leaderboard.\n\n` +
                  `| Label | Points |\n|---|---|\n` +
                  `| \`level-1\` | 5 pts |\n| \`level-2\` | 20 pts |` +
                  footer
                );
                return;
              }
              points = prResult.points;
              level  = prResult.level + ' (admin assigned)';
            }

            // â”€â”€ 3. Post award comment on the PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            await postComment(
              `## ğŸ‰ PR Merged â€” Points Awarded!\n\n` +
              `Congratulations @${author}! Your contribution has been merged.\n\n` +
              `| Field | Value |\n|---|---|\n` +
              `| **Repo** | ${sourceRepo} |\n` +
              `| **Team** | ${teamLabel} |\n` +
              `| **Contributor** | @${author} |\n` +
              `| **Level** | ${level} |\n` +
              `| **Points Awarded** | ${points} pts |\n` +
              `| **Source** | ${pointSource} |\n\n` +
              `The central leaderboard has been updated. Keep contributing!` +
              footer
            );

            // â”€â”€ 4. Load leaderboard.json from central repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const LB_PATH = 'leaderboard-repo/leaderboard.json';
            let db = { teams: {}, contributors: {} };

            if (fs.existsSync(LB_PATH)) {
              try { db = JSON.parse(fs.readFileSync(LB_PATH, 'utf8')); } catch (_) {}
            }
            if (!db.teams)        db.teams        = {};
            if (!db.contributors) db.contributors = {};

            // â”€â”€ 5. Update team record â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (!db.teams[teamLabel]) {
              db.teams[teamLabel] = { points: 0, prs: 0, contributors: [], repos: [] };
            }
            db.teams[teamLabel].points += points;
            db.teams[teamLabel].prs    += 1;
            if (!db.teams[teamLabel].contributors.includes(author)) {
              db.teams[teamLabel].contributors.push(author);
            }
            if (!db.teams[teamLabel].repos) db.teams[teamLabel].repos = [];
            if (!db.teams[teamLabel].repos.includes(sourceRepo)) {
              db.teams[teamLabel].repos.push(sourceRepo);
            }

            // â”€â”€ 6. Update contributor record â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (!db.contributors[author]) {
              db.contributors[author] = { points: 0, prs: 0, team: teamLabel, repos: [] };
            }
            db.contributors[author].points += points;
            db.contributors[author].prs    += 1;
            db.contributors[author].team    = teamLabel;
            if (!db.contributors[author].repos) db.contributors[author].repos = [];
            if (!db.contributors[author].repos.includes(sourceRepo)) {
              db.contributors[author].repos.push(sourceRepo);
            }

            fs.writeFileSync(LB_PATH, JSON.stringify(db, null, 2));

            // â”€â”€ 7. Render leaderboard.md â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            const now    = new Date().toUTCString();

            // Team rankings
            const sortedTeams = Object.entries(db.teams)
              .sort((a, b) => b[1].points - a[1].points || b[1].prs - a[1].prs);

            const teamRows = sortedTeams.map(([team, data], i) => {
              const rank    = i < 3 ? medals[i] : `${i + 1}.`;
              const repos   = (data.repos || []).join(', ');
              const members = data.contributors.map(c => `@${c}`).join(', ');
              return `| ${rank} | **${team}** | ${data.points} | ${data.prs} | ${data.contributors.length} | ${repos} | ${members} |`;
            }).join('\n');

            // Individual contributors
            const sortedContribs = Object.entries(db.contributors)
              .sort((a, b) => b[1].points - a[1].points || b[1].prs - a[1].prs);

            const contribRows = sortedContribs.map(([user, data], i) => {
              const rank  = i < 3 ? medals[i] : `${i + 1}.`;
              const repos = (data.repos || []).join(', ');
              return `| ${rank} | @${user} | ${data.team} | ${data.points} | ${data.prs} | ${repos} |`;
            }).join('\n');

            const mdBody =
              `# ğŸ† GDG CHARUSAT Open Source Contri Sprintathon â€” Leaderboard\n\n` +
              `> **Last Updated:** ${now}\n` +
              `> **Tracking:** Zaplink_frontend Â· Zaplink_backend Â· CareXpert_frontend Â· CareXpert_backend Â· Code_duel_frontend Â· Code_duel_backend\n\n` +
              `---\n\n` +

              `## ğŸ‘¥ Team Rankings\n\n` +
              `| Rank | Team | Total Points | PRs Merged | Members | Active Repos | Contributors |\n` +
              `|------|------|:------------:|:----------:|:-------:|--------------|---------------|\n` +
              (teamRows || `| â€” | No teams yet | 0 | 0 | 0 | â€” | â€” |`) +
              `\n\n---\n\n` +

              `## ğŸ§‘â€ğŸ’» Individual Contributors\n\n` +
              `| Rank | GitHub | Team | Points | PRs Merged | Repos |\n` +
              `|------|--------|------|:------:|:----------:|-------|\n` +
              (contribRows || `| â€” | No contributors yet | â€” | 0 | 0 | â€” |`) +
              `\n\n---\n\n` +

              `## Points System\n\n` +
              `| Level | Label | Points |\n` +
              `|-------|-------|:------:|\n` +
              `| Beginner | \`level-1\` / \`good-first-issue\` | 5 pts |\n` +
              `| Intermediate | \`level-2\` / \`intermediate\` | 20 pts |\n` +
              `| General Improvement | Admin assigns level on PR | 5 or 20 pts |\n\n` +
              `---\n\n` +
              `*Auto-updated on every merged PR across all 6 repos Â· Maintained by GDG CHARUSAT*\n`;

            fs.writeFileSync('leaderboard-repo/leaderboard.md', mdBody);
            core.info(`âœ… Central leaderboard updated â€” ${sourceRepo} / ${teamLabel} / @${author}: +${points} pts`);

      # â”€â”€ Commit back to the central leaderboard repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit leaderboard update
        run: |
          cd leaderboard-repo
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add leaderboard.json leaderboard.md
          git diff --staged --quiet || git commit -m "chore: update leaderboard â€” ${{ github.repository }} PR #${{ github.event.pull_request.number }} [skip ci]"
          git push
