name: PR Validator
on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]
permissions:
  pull-requests: write
  issues: write
  contents: read
jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const prNumber = pr.number;
            const author = pr.user.login;

            const ensureLabel = async (name, color, description) => {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name,
                  color,
                  description
                });
              } catch (_) {}
            };

            await ensureLabel('invalid-pr', 'e11d48', 'PR is missing required information');
            await ensureLabel('needs-review', '7c3aed', 'Valid issue-linked PR awaiting review');
            await ensureLabel('needs-admin-review', 'f59e0b', 'General improvement PR - admin must assign level');
            await ensureLabel('level-1', '22c55e', 'Beginner contribution (5 pts)');
            await ensureLabel('level-2', 'f97316', 'Intermediate contribution (20 pts)');

            try {
              const REVIEWER = 'krishnapaljadeja';
              if (author !== REVIEWER) {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  reviewers: [REVIEWER]
                });
              }
            } catch (_) {}

            const removeLabel = async (label) => {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label
                });
              } catch (_) {}
            };

            await removeLabel('invalid-pr');
            await removeLabel('needs-review');
            await removeLabel('needs-admin-review');

            // Hidden HTML tags to identify bot comments (prevents duplicate spam)
            const BOT_TAG_INVALID = '<!-- gdg-bot: invalid-pr -->';
            const BOT_TAG_VALID = '<!-- gdg-bot: needs-review -->';
            const BOT_TAG_ADMIN = '<!-- gdg-bot: needs-admin-review -->';

            const existingComments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            // PAT_TOKEN posts as a real user, not type=Bot, so match by tag only
            const botComments = existingComments.data
              .filter(c =>
                c.body.includes(BOT_TAG_INVALID) ||
                c.body.includes(BOT_TAG_VALID) ||
                c.body.includes(BOT_TAG_ADMIN)
              );

            const lastBotComment = botComments[botComments.length - 1];

            const teamMatch = body.match(/team\s*\d+/i);
            const hasTeamNumber = Boolean(teamMatch);
            const teamLabel = hasTeamNumber ? teamMatch[0].replace(/\s+/g, ' ').trim() : null;

            const issueMatch = body.match(/(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#\d+/i);
            const hasLinkedIssue = Boolean(issueMatch);

            const postComment = async (body) => {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            };

            const addLabels = async (...labels) => {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels
              });
            };

            const footer = '\n\n> GDG CHARUSAT Open Source Contri Sprintathon';

            if (!hasTeamNumber) {
              await addLabels('invalid-pr');
              if (!lastBotComment || !lastBotComment.body.includes(BOT_TAG_INVALID)) {
                await postComment(
                  `${BOT_TAG_INVALID}\n` +
                  `## âš ï¸ PR Validation Failed\n\n` +
                  `Hey @${author}! Your PR is missing a required field:\n\n` +
                  `**Team Number missing** â€” add your team number anywhere in the PR description.\n` +
                  `Example: \`Team 07\`\n\n` +
                  `**How to fix:**\n` +
                  `1. Click the pencil âœï¸ icon on your PR description\n` +
                  `2. Add your team number (e.g. \`Team 07\`)\n` +
                  `3. Save â€” this check will re-run automatically` +
                  footer
                );
              }
              return;
            }

            if (hasLinkedIssue) {
              await addLabels('needs-review');
              if (!lastBotComment || !lastBotComment.body.includes(BOT_TAG_VALID)) {
                await postComment(
                  `${BOT_TAG_VALID}\n` +
                  `## âœ… PR Validation Passed\n\n` +
                  `Hey @${author}! Your PR looks good. Here is what we found:\n\n` +
                  `| Field | Value |\n` +
                  `|---|---|\n` +
                  `| **Team Number** | ${teamLabel} |\n` +
                  `| **Linked Issue** | ${issueMatch[0]} |\n\n` +
                  `A maintainer will review your PR within 24â€“48 hours. Stay responsive to feedback!` +
                  footer
                );
              }
              return;
            }

            await addLabels('needs-admin-review');
            if (!lastBotComment || !lastBotComment.body.includes(BOT_TAG_ADMIN)) {
              await postComment(
                `${BOT_TAG_ADMIN}\n` +
                `## ðŸ” General Improvement PR â€” Pending Admin Review\n\n` +
                `Hey @${author}! Your PR has been received as a **General Improvement PR** (no linked issue).\n\n` +
                `| Field | Value |\n` +
                `|---|---|\n` +
                `| **Team Number** | ${teamLabel} |\n` +
                `| **Linked Issue** | None |\n\n` +
                `**What happens next:**\n` +
                `1. An admin will review your changes\n` +
                `2. If approved, an admin will add a \`level-1\` or \`level-2\` label based on complexity\n` +
                `3. Points are calculated automatically when the PR is merged\n\n` +
                `> âš ï¸ Trivial or low-quality PRs may be closed without merging.\n` +
                `> Admin review may take longer than standard PRs.` +
                footer
              );
            }
